!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).LegoinoSerial={})}(this,(function(e){"use strict";var t={exports:{}};const i=()=>{const e=new Error("Delay aborted");return e.name="AbortError",e},s=e=>{let{clearTimeout:t,setTimeout:s,willResolve:n}=e;return function(e){let r,o,a,{value:l,signal:c}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(c&&c.aborted)return Promise.reject(i());const d=t||clearTimeout,h=()=>{d(r),a(i())},m=()=>{c&&c.removeEventListener("abort",h)},u=new Promise(((t,i)=>{o=()=>{m(),n?t(l):i(l)},a=i,r=(s||setTimeout)(o,e)}));return c&&c.addEventListener("abort",h,{once:!0}),u.clear=()=>{d(r),r=null,o()},u}},n=e=>{const t=s({...e,willResolve:!0});return t.reject=s({...e,willResolve:!1}),t.range=(e,i,s)=>t(((e,t)=>Math.floor(Math.random()*(t-e+1)+e))(e,i),s),t},r=n();r.createWithTimers=n,t.exports=r,t.exports.default=r;var o=t.exports;const a=new TextEncoder,l=new TextDecoder;class c{constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.device=t,this.currentTimeout=void 0,this.command=e,this.timeout=i.timeout??200,this.timeoutResolve=i.timeoutResolve??!1,this.disableTerminal=i.disableTerminal??!1,this.kind=i.kind??"writeRead",this.answer="",this.partialAnswer="",this.logger=i.logger,this.status=0,this.creationTimestamp=Date.now(),this.promise=new Promise(((e,t)=>{this.reject=t,this.resolve=e})),this.isEndCommandAnswer=i.isEndCommandAnswer??(()=>{throw new Error("isEndCommandAnswer is not defined")}),this.endCommandAnswerCallback=i.endCommandAnswerCallback??(()=>{throw new Error("endCommandAnswerCallback is not defined")}),this.logger?.info("Action created")}isFinished(){return 50===this.status||60===this.status}setTimeout(){this.currentTimeout&&clearTimeout(this.currentTimeout),this.currentTimeout=setTimeout((()=>{50!==this.status&&60!==this.status&&(this.timeoutResolve?(this.status=50,this.resolve(this.partialAnswer),!this.disableTerminal&&this.device.terminal?.receive(this.partialAnswer),this.logger?.info(`Timeout resolved after ${this.timeout}ms`)):(this.status=60,this.reject(this.partialAnswer),!this.disableTerminal&&this.device.terminal?.receive(this.partialAnswer),this.logger?.error(`Timeout reject after ${this.timeout}ms`)))}),this.timeout)}async writeRead(){return this.startTimestamp=Date.now(),this.status=10,await this.setTimeout(),this.writeText(this.command).then((async()=>{await this.readText(),this.status=40,this.answer=this.endCommandAnswerCallback(this.command,this.partialAnswer)})).then((()=>{this.status=50,this.resolve(this.answer)})),this.promise}async writeText(e){if(!e)return;const t=a.encode(`${e}\n`);return!this.disableTerminal&&this.device.terminal?.send(e),this.device.writer.write(t)}async readText(){for(this.status=30;30===this.status;){const e=await this.device.reader.read();if(e.value.length>0&&this.setTimeout(),this.partialAnswer+=l.decode(e.value),this.isEndCommandAnswer(this.command,this.partialAnswer))break;await o(5)}!this.disableTerminal&&this.device.terminal?.receive(this.partialAnswer)}}const d={1:"opening",2:"opened",3:"closed",9:"missing",10:"error"};class h{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{commandOptions:i={},deviceOptions:s={}}=t;this.logger=t.logger,this.terminal=t.terminal,this.setStatus(1),this.id=void 0,this.serialPort=e,this.baudRate=s.baudRate||115200,this.interCommandDelay=s.interCommandDelay||10,this.getID=s.getID??(async e=>`${e.usbVendorId}-${e.usbProductId}`),this.timeout=s.timeout||100,this.commandOptions=i,this.queue=[],this.action=void 0,this.usbVendorId=t.usbVendorId,this.usbProductId=t.usbProductId,this.logger?.info("Device created")}setStatus(e){this.status=e,this.statusLabel=d[e]}isReady(){return 2===this.status}async ensureProcessQueue(){return this.logger?.info("ensureProcessQueue"),this.currentProcessQueue||(this.currentProcessQueue=this.runProcessQueue()),this.currentProcessQueue}async runProcessQueue(){for(;this.queue.length>0;)this.action=this.queue.shift(),this.action&&(await this.action.writeRead().then((e=>{this.logger?.info({command:this.action.command,answer:this.action.answer},"Resolve writeRead command")})).catch((e=>{this.logger?.error({command:this.action?.command,answer:this.action.partialAnswer},e.toString())})),this.action=void 0,await o(this.interCommandDelay));this.currentProcessQueue=void 0}async getStatus(){return{value:this.status}}async ensureOpen(){this.logger?.trace("Ensure open");let e=0;for(;1===this.status&&e++<100;)await o(10);if(2!==this.status)return this.open()}async open(){this.logger?.info("Opening"),await this.serialPort.open({baudRate:this.baudRate}).catch((e=>{this.error(e),this.close()})).then((()=>{this.ensureOpen()})),this.reader=this.serialPort.readable.getReader(),this.writer=this.serialPort.writable.getWriter(),this.logger?.info("Getting id"),this.id=await this.getID(this),this.logger?.info(`Id: ${this.id}`),this.setStatus(2)}async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{timeout:i=this.timeout,timeoutResolve:s=!1,disableTerminal:n=!1,unique:r=!1}=t;if(r&&(this.action?.command===e||this.queue.find((t=>t.command===e))))return;const o=new c(e,this,{...this.commandOptions,timeout:i,timeoutResolve:s,disableTerminal:n,logger:this.logger.child({kind:"Command",command:e})});return this.queue.push(o),this.ensureProcessQueue(),o.promise}error(e){this.logger?.error(e,`Error ${this.serialPort?.path}`),this.setStatus(10)}close(){this.logger?.info("Close"),this.setStatus(3)}}class m{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}emit(e,t){let i=this.callbacks[e];i&&i.forEach((e=>e(t)))}}for(var u,p=256,g=[];p--;)g[p]=(p+256).toString(16).substring(1);function f(){var e,t=0,i="";if(!u||p+16>256){for(u=Array(t=256);t--;)u[t]=256*Math.random()|0;t=p=0}for(;t<16;t++)e=u[p+t],i+=6==t?g[15&e|64]:8==t?g[63&e|128]:g[e],1&t&&t>1&&t<11&&(i+="-");return p++,i}const v={1:"Hard limit triggered. Machine position is likely lost due to sudden and immediate halt. Re-homing is highly recommended.",2:"G-code motion target exceeds machine travel. Machine position safely retained. Alarm may be unlocked.",3:"Reset while in motion. Grbl cannot guarantee position. Lost steps are likely. Re-homing is highly recommended.",4:"Probe fail. The probe is not in the expected initial state before starting probe cycle, where G38.2 and G38.3 is not triggered and G38.4 and G38.5 is triggered.",5:"Probe fail. Probe did not contact the workpiece within the programmed travel for G38.2 and G38.4.",6:"Homing fail. Reset during active homing cycle.",7:"Homing fail. Safety door was opened during active homing cycle.",8:"Homing fail. Cycle failed to clear limit switch when pulling off. Try increasing pull-off setting or check wiring.",9:"Homing fail. Could not find limit switch within search distance. Defined as `1.5 * max_travel` on search and `5 * pulloff` on locate phases."},b={1:"G-code words consist of a letter and a value. Letter was not found.",2:"Numeric value format is not valid or missing an expected value.",3:"Grbl `$` system command was not recognized or supported.",4:"Negative value received for an expected positive value.",5:"Homing cycle is not enabled via settings.",6:"Minimum step pulse time must be greater than 3usec",7:"EEPROM read failed. Reset and restored to default values.",8:"Grbl `$` command cannot be used unless Grbl is IDLE. Ensures smooth operation during a job.",9:"G-code locked out during alarm or jog state",10:"Soft limits cannot be enabled without homing also enabled.",11:"Max characters per line exceeded. Line was not processed and executed.",12:"(Compile Option) Grbl `$` setting value exceeds the maximum step rate supported.",13:"Safety door detected as opened and door state initiated.",14:"(Grbl-Mega Only) Build info or startup line exceeded EEPROM line length limit.",15:"Jog target exceeds machine travel. Command ignored.",16:"Jog command with no `=` or contains prohibited g-code.",17:"Laser mode disabled. Requires PWM output.",20:"Unsupported or invalid g-code command found in block.",21:"More than one g-code command from same modal group found in block.",22:"Feed rate has not yet been set or is undefined.",23:"G-code command in block requires an integer value.",24:"Two G-code commands that both require the use of the `XYZ` axis words were detected in the block.",25:"A G-code word was repeated in the block.",26:"A G-code command implicitly or explicitly requires `XYZ` axis words in the block, but none were detected.",27:"`N` line number value is not within the valid range of `1` - `9,999,999`.",28:"A G-code command was sent, but is missing some required `P` or `L` value words in the line.",29:"Grbl supports six work coordinate systems `G54-G59`. `G59.1`, `G59.2`, and `G59.3` are not supported.",30:"The `G53` G-code command requires either a `G0` seek or `G1` feed motion mode to be active. A different motion was active.",31:"There are unused axis words in the block and `G80` motion mode cancel is active.",32:"A `G2` or `G3` arc was commanded but there are no `XYZ` axis words in the selected plane to trace the arc.",33:"The motion command has an invalid target. `G2`, `G3`, and `G38.2` generates this error, if the arc is impossible to generate or if the probe target is the current position.",34:"A `G2` or `G3` arc, traced with the radius definition, had a mathematical error when computing the arc geometry. Try either breaking up the arc into semi-circles or quadrants, or redefine them with the arc offset definition.",35:"A `G2` or `G3` arc, traced with the offset definition, is missing the `IJK` offset word in the selected plane to trace the arc.",36:"There are unused, leftover G-code words that aren't used by any command in the block.",37:"The `G43.1` dynamic tool length offset command cannot apply an offset to an axis other than its configured axis. The Grbl default axis is the Z-axis.",38:"Tool number greater than max supported value."},w={},y={$0:"Step pulse time, microseconds",$1:"Step idle delay, milliseconds",$2:"Step pulse invert, mask",$3:"Step direction invert, mask",$4:"Invert step enable pin, boolean",$5:"Invert limit pins, boolean",$6:"Invert probe pin, boolean",$10:"Status report options, mask",$11:"Junction deviation, millimeters",$12:"Arc tolerance, millimeters",$13:"Report in inches, boolean",$20:"Soft limits enable, boolean",$21:"Hard limits enable, boolean",$22:"Homing cycle enable, boolean",$23:"Homing direction invert, mask",$24:"Homing locate feed rate, mm/min",$25:"Homing search seek rate, mm/min ",$26:"Homing switch debounce delay, milliseconds",$27:"Homing switch pull-off distance, millimeters",$30:"Maximum spindle speed, RPM",$31:"Minimum spindle speed, RPM",$32:"Laser-mode enable, boolean",$100:"X-axis steps per millimeter",$101:"Y-axis steps per millimeter",$102:"Z-axis steps per millimeter",$110:"X-axis maximum rate, mm/min",$111:"Y-axis maximum rate, mm/min",$112:"Z-axis maximum rate, mm/min",$120:"X-axis acceleration, mm/sec^2",$121:"Y-axis acceleration, mm/sec^2",$122:"Z-axis acceleration, mm/sec^2",$130:"X-axis maximum travel, millimeters",$131:"Y-axis maximum travel, millimeters",$132:"Z-axis maximum travel, millimeters"};function x(e,t){const[,i]=e.split(":");P({kind:"ERROR",code:i,description:b[i]},t)}function $(e,t){const[,i]=e.split(":");P({kind:"ALARM",code:i,description:v[i]},t)}function G(e,t){const[i,s]=e.split("=");t.settings[i]={key:i,description:y[i],value:Number(s)}}const T={HLP:"Help",MSG:"Message",GC:"GCode",VER:"Version",OPT:"Option",echo:"Echo"};function k(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const[i,s]=e.replace(/\[(.*)\]/,"$1").split(":"),n=e.replace(/\[(.*)\]/,"$1").split(":").slice(1).join(":");switch(i){case"echo":case"VER":case"OPT":case"HLP":case"GC":case"MSG":return void P({kind:T[i],description:n},t);default:t.parameters[i]={key:i,description:w[i],value:s.split(",").map((e=>Number(e)))}}}function R(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=e.replace(/<(.*)>/,"$1").split("|"),s={value:i[0],Pn:[!1,!1,!1]};for(let e=1;e<i.length;e++){const[t,n]=i[e].split(":");s[t]="Pn"===t?[n.includes("X"),n.includes("Y"),n.includes("Z")]:n.split(",").map((e=>Number(e)))}t.status={...t.status,...s}}function P(e,t){t.messages.push({epoch:Date.now(),...e}),t.messages.length>20&&t.messages.splice(0,t.messages.length-20),console.log(t.messages)}const A={updateState:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e)return;const i=e.split(/\r?\n/);for(let e of i)e.startsWith("<")&&R(e,t),e.startsWith("[")&&k(e,t),e.startsWith("$")&&G(e,t),e.startsWith("Grbl")&&(t.version=e.replace("Grbl ","")),e.startsWith("error")&&x(e,t),e.includes("ALARM")&&$(e,t)},getEmptyState:function(){return{messages:[],status:{},settings:{},parameters:{},version:"",gcode:{currentLine:0,sentLine:1}}}};e.DevicesManager=class extends m{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),function(e){e||(console.error("Web serial doesn't seem to be enabled in your browser. Try enabling it by visiting:"),console.error("chrome://flags/#enable-experimental-web-platform-features"),console.error("opera://flags/#enable-experimental-web-platform-features"),console.error("edge://flags/#enable-experimental-web-platform-features"))}(e),this.serial=e,this.terminal=t.terminal,this.logger=t.logger,this.devices=[],this.portFilter=t.portFilter,this.commandOptions=t.command??{},this.deviceOptions=t.device??{}}async requestDevices(){return await this.serial.requestPort({filters:this.portFilter}),this.updateDevices()}async updateDevices(){const e=await this.serial.getPorts();this.logger?.trace("start updateDevices");const t=this.devices.filter((t=>!e.includes(t.serialPort)));for(let e of t)9!==e.status&&3!==e.status&&e.close(),e.status=9;for(let t of e){let e=this.devices.find((e=>e.serialPort===t));if(e)await e.ensureOpen();else{const e=t.getInfo();let i=new h(t,{baudRate:this.baudRate,terminal:this.terminal,...e,commandOptions:this.commandOptions,deviceOptions:this.deviceOptions,logger:this.logger.child({kind:"Device",...t.getInfo()})});this.devices.push(i),await i.open()}}this.logger?.trace("finish updateDevices")}async continuousUpdateDevices(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{scanInterval:t=1e3,callback:i}=e;for(;;)await this.updateDevices(),i&&i(this.devices),await o(t)}getDevicesList(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{ready:t=!1}=e;return this.devices.filter((e=>!t||e.isReady())).map((e=>({status:e.status,id:e.id,queueLength:e.queue.length})))}findDevice(e){if(void 0===e)return;let t=this.devices.filter((t=>t.id===e&&2===t.status));if(0!==t.length){if(t.length>1)throw new Error(`Many devices have the same id: ${e}`);return t[0]}}async sendCommand(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=this.findDevice(e);if(!s)throw Error(`Device ${e} not found`);if(s&&s.isReady())return s.get(t,i);throw Error(`Device ${e} not ready: ${s.port.path}`)}},e.GRBL=A,e.Terminal=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.start=Date.now(),this.lineNumber=0,this.eventNumber=0,this.limit=e.limit??1e3,this.onChange=e.onChange,this.ignoreSend=e.ignoreSend??[],this.ignoreReceive=e.ignoreReceive??[],this.showSpecial=e.showSpecial??!0,this.sendColor=e.sendColor??"#efcef2",this.receiveColor=e.receiveColor??"#bbeeb7",this.events=[]}send(e){this.append(e,"send")}receive(e){this.append(e,"receive")}shouldIgnore(e,t){const i="send"===t?this.ignoreSend:this.ignoreReceive;for(let t of i)if(t.test(e))return!0;return!1}append(e,t){const i=function(e,t){t&&(e=e.replace(/\r/g,"<CR>").replace(/\n/g,"<LF>\n").replace(/\t/g,"<TAB>\t"));return e.replace(/[\r\n]+$/,"").split(/\r?\n/)}(e,this.showSpecial);this.eventNumber++;const s=[];for(let e of i){this.lineNumber++;const i={uuid:f(),time:Math.round(Date.now()-this.start),lineNumber:this.lineNumber,eventNumber:this.eventNumber,kind:t,line:e};this.shouldIgnore(e,t)||(s.push(i),this.events.push(i))}this.events.length>this.limit&&this.events.splice(0,this.events.length-this.limit),this.onChange?.(s,this.events)}toHtml(){let e=[];e.push('<div style="background-color:black">');for(let i of this.events)e.push(`<div style="color: ${"send"===i.kind?this.sendColor:this.receiveColor}">${(i.time/1e3).toFixed(3)}: ${t=i.line,t.replace(/&/g,"&amp").replace(/>/g,"&gt").replace(/</g,"&lt")}</div>`);var t;return e.push("</div>"),e.join("\n")}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=legoino-navigator-serial.min.js.map
