!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).LegoinoSerial={})}(this,(function(e){"use strict";const t=()=>{const e=new Error("Delay aborted");return e.name="AbortError",e},s=({clearTimeout:e,setTimeout:s,willResolve:i})=>(r,{value:a,signal:o}={})=>{if(o&&o.aborted)return Promise.reject(t());let n,u,l;const h=e||clearTimeout,c=()=>{h(n),l(t())},d=new Promise(((e,t)=>{u=()=>{o&&o.removeEventListener("abort",c),i?e(a):t(a)},l=t,n=(s||setTimeout)(u,r)}));return o&&o.addEventListener("abort",c,{once:!0}),d.clear=()=>{h(n),n=null,u()},d},i=s({willResolve:!0});i.reject=s({willResolve:!1}),i.range=(e,t,s)=>i(((e,t)=>Math.floor(Math.random()*(t-e+1)+e))(e,t),s),i.createWithTimers=({clearTimeout:e,setTimeout:t})=>{const i=s({clearTimeout:e,setTimeout:t,willResolve:!0});return i.reject=s({clearTimeout:e,setTimeout:t,willResolve:!1}),i};var r=i,a=i;r.default=a;class o{constructor(e,t={}){this.currentTimeout=void 0,this.command=e,this.timeout=void 0===t.timeout?1e3:t.timeout,this.answer="",this.status=0,this.creationTimestamp=Date.now(),this.promise=new Promise(((e,t)=>{this.reject=t,this.resolve=e})),this.finishedPromise=new Promise((e=>{this.finished=e}))}isFinished(){return 4===this.status||5===this.status}setTimeout(){this.currentTimeout&&clearTimeout(this.currentTimeout),this.currentTimeout=setTimeout((()=>{4!==this.status&&5!==this.status&&(this.status=5,this.reject("Timeout"),this.finished())}),this.timeout)}start(){this.startTimestamp=Date.now(),this.status=1,this.setTimeout()}appendAnswer(e){let t=(new TextDecoder).decode(e);if(this.status=2,this.answer+=t,!this.answer.replace(/\r/g,"").endsWith("\n\n"))return;let s=this.answer.split(/\r?\n/);s.length>0&&""===s[s.length-1]&&(s=s.filter((e=>e)),this.status=3,this.resolve(s.join("\n")),this.finished(),this.status=4)}}const n=console.log;class u{constructor(e,t={}){this.status=1,this.id=void 0,this.serialPort=e,this.baudRate=t.baudRate||115200,this.queue=[],this.action=void 0,this.interCommandDelay=t.interCommandDelay,this.defaultCommandExpirationDelay=2e3,this.encoder=new TextEncoder,this.decoder=new TextDecoder}isReady(){return 2===this.status}async ensureProcessQueue(){return n("ensureProcessQueue"),this.currentProcessQueue||(this.currentProcessQueue=this.runProcessQueue()),this.currentProcessQueue}async runProcessQueue(){for(;this.queue.length>0;)this.action=this.queue.shift(),this.action&&(this.action.start(),await this.write(this.action.command+"\n"),await this.read(this.action),await this.action.finishedPromise,this.action=void 0,await r(this.interCommandDelay));this.currentProcessQueue=void 0}async getStatus(){return{value:this.status}}async ensureOpen(){if(n("Ensure open"),2!==this.status)return this.open()}async open(){n("Opening"),await this.serialPort.open({baudRate:this.baudRate}),this.reader=this.serialPort.readable.getReader(),this.writer=this.serialPort.writable.getWriter(),this.id=await this.get("uq"),this.status=2}async get(e,t={}){const{commandExpirationDelay:s=this.defaultCommandExpirationDelay}=t,i=new o(e,{timeout:s});return this.queue.push(i),this.ensureProcessQueue(),i.promise}error(e){n("Error "+this.port.path),n(e),this.status=10,this.emit("adapter",{event:"Error",value:e})}close(){n("Close"),this.status=3}async write(e){const t=this.encoder.encode(e+"\n");return this.writer.write(t)}async read(e){for(;!e.isFinished();)e.appendAnswer((await this.reader.read()).value),r(10)}}const l=console.log;e.DevicesManager=class extends class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]||(this.callbacks[e]=[]),this.callbacks[e].push(t)}emit(e,t){let s=this.callbacks[e];s&&s.forEach((e=>e(t)))}}{constructor(e,t={}){super(),function(e){e||(console.error("Web serial doesn't seem to be enabled in your browser. Try enabling it by visiting:"),console.error("chrome://flags/#enable-experimental-web-platform-features"),console.error("opera://flags/#enable-experimental-web-platform-features"),console.error("edge://flags/#enable-experimental-web-platform-features"))}(e),this.serial=e,this.devices=[],this.portFilter=void 0===t.portFilter?[{usbProductId:37384,usbVendorId:6991}]:t.portFilter,this.baudRate=t.baudRate||115200,this.interCommandDelay=void 0===t.interCommandDelay?100:t.interCommandDelay,this.defaultCommandExpirationDelay=void 0===t.defaultCommandExpirationDelay?100:t.defaultCommandExpirationDelay}async requestDevices(){return await this.serial.requestPort({filters:this.portFilter}),this.updateDevices()}async updateDevices(){const e=await this.serial.getPorts();l("updateDevices");const t=this.devices.filter((t=>!e.includes(t.serialPort)));for(let e of t)9!==e.status&&3!==e.status&&e.close(),e.status=9;for(let t of e){let e=this.devices.filter((e=>e.serialPort===t))[0];if(e)await e.ensureOpen();else{let e=new u(t,{baudRate:this.baudRate,interCommandDelay:this.interCommandDelay,defaultCommandExpirationDelay:this.defaultCommandExpirationDelay});this.devices.push(e),await e.open()}}}async continuousUpdateDevices(e={}){const{scanInterval:t=1e3,callback:s}=e;for(;;)await this.updateDevices(),s&&s(this.devices),await r(t)}getDevicesList(e={}){let{ready:t=!1}=e;return this.devices.filter((e=>!t||e.isReady())).map((e=>({status:e.status,id:e.id,queueLength:e.queue.length})))}findDevice(e){if(void 0===e)return;let t=this.devices.filter((t=>t.id===e&&2===t.status));if(0!==t.length){if(t.length>1)throw new Error("Many devices have the same id: "+e);return t[0]}}async sendCommand(e,t){const s=this.findDevice(e);if(!s)throw Error(`Device ${e} not found`);if(s&&s.isReady())return s.get(t);throw Error(`Device ${e} not ready: ${s.port.path}`)}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=legoino-navigator-serial.min.js.map
