<html>
  <head>
    <script src="https://www.lactame.com/lib/fifo-logger/0.3.0/fifo-logger.js"></script>
    <script src="./logger.js"></script>
    <script src="./devicesToTable.js"></script>
    <script src="./grbl.js"></script>
    <script src="../dist/legoino-navigator-serial.js"></script>
  </head>
  <body>
    <div>
      <p>
        <button onclick="devicesManager.updateDevices()">updateDevices</button>
        <button onclick="devicesManager.requestDevices()">
          requestDevices
        </button>
        <input type="text" value="$" id="command" />
        <button onclick="sendCommand(getElementById('command').value)">
          sendCommand
        </button>
      </p>
      <p>
        <button onclick="sendCommand(String.fromCharCode(0x18))">ctrl-x</button>
        <button onclick="sendCommand('=')">? Status</button>
        <button onclick="sendCommand('~')">~ cycle start/resume</button>
        <button onclick="sendCommand('!')">! Feed hold</button>
      </p>
      <p>
        <button onclick="sendCommand('G0 X0 Y0 Z0')">G0 X0 Y0 Z0</button>
        <button onclick="sendCommand('G0 X100 Y0 Z0')">G0 X100 Y0 Z0</button>
        <button onclick="sendCommand('G0 X0 Y100 Z0')">G0 X0 Y100 Z0</button>
        <button onclick="sendCommand('G0 X0 Y0 Z100')">G0 X0 Y0 Z100</button>
      </p>
    </div>

    <div style="display: flex; flex-direction: row" ;>
      <textarea id="result" cols="50" rows="30"></textarea>
      <div id="status"></div>
    </div>
    <div id="devices"></div>
    <div id="logs"></div>
    <script>
      const devicesManager = new LegoinoSerial.DevicesManager(
        navigator.serial,
        {
          logger,
          portFilter: [
            { usbProductId: 67, usbVendorId: 9025 }, // arduino uno
            { usbProductId: 37384, usbVendorId: 6991 },
            { usbProductId: 60000, usbVendorId: 4292 },
          ],
          command: {
            isEndCommandAnswer: (command, answer) => {
              return answer.match('ok\n') || answer.match('error: (.*)\n');
            },
            endCommandAnswerCallback: (command, answer) => {
              return answer;
            },
          },
          device: {
            interCommandDelay: 500,
            timeout: 2000,
          },
        },
      );
      async function doAll() {
        await devicesManager.updateDevices();
        let devices = devicesManager.getDevicesList();

        devicesManager.continuousUpdateDevices({
          callback: (devices) => {
            const table = devicesToTable(devices);
            document.getElementById('devices').innerHTML = table;
          },
        });

        window.setTimeout(() => {
          window.setInterval(async () => {
            await sendCommand('?', { showRaw: false });
          }, 500);
        }, 50);
      }
      doAll();

      let status = { status: '', info: {} };
      async function sendCommand(command, options = {}) {
        const { showRaw = true } = options;
        let result = await devicesManager.sendCommand('9025-67', command);
        const parsed = parse(command, result);
        if (command === '?') {
          status.status = parsed.status;
          status.info = { ...status.info, ...parsed.info };
          document.getElementById('status').innerHTML = `
            <h2>Status: ${status.status}</h2>
            <h3>X: ${status.info?.MPos?.[0]}</h3>
            <h3>Y: ${status.info?.MPos?.[1]}</h3>
            <h3>Z: ${status.info?.MPos?.[2]}</h3>
            FS: ${status.info.FS}<br/>
            Ov: ${status.info.Ov}<br/>
            WCO: ${status.info.Ov}<br/>
         `;
        }
        if (showRaw) {
          document.getElementById('result').value = result;
        }
      }
    </script>
  </body>
</html>
